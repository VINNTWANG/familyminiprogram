<!--pages/post-detail/index.wxml-->
<view class="container">
  <view class="native-navbar" style="height: {{navBarHeightRpx + statusBarHeightRpx}}rpx; padding-top: {{statusBarHeightRpx}}rpx;">
    <view class="nav-content" style="height: {{navBarHeightRpx}}rpx;">
      <view class="nav-left" bind:tap="navigateBack">
        <view class="back-icon">ã€?/view>
      </view>
      <view class="nav-title">åŠ¨æ€è¯¦æƒ?/view>
      <view style="width: 100rpx;"></view> <!-- Placeholder for alignment -->
    </view>
  </view>

  <view class="page" style="padding-top: {{navBarHeightRpx + statusBarHeightRpx}}rpx;">
    <!-- Loading State -->
    <view wx:if="{{isLoading}}" class="loading-container">
      <view class="post-skeleton"></view>
    </view>

    <!-- Error State -->
    <view wx:elif="{{loadError}}" class="error-container">
      <text>åŠ¨æ€åŠ è½½å¤±è´?/text>
      <text>è¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•</text>
    </view>

    <!-- Content -->
    <block wx:else>
      <!-- Post Card -->
      <post-card post="{{post}}" hideFooter="{{true}}" show-comment-btn="{{false}}" show-reaction-btn="{{false}}"></post-card>

      <!-- Action Bar -->
      <view class="action-bar">
        <view class="action-item {{post.liked ? 'on' : ''}}" bind:tap="handleLike">
          <view class="icon">â¤ï¸</view>
          <view class="label">{{post.likes}}</view>
        </view>
        <view class="action-item" bind:tap="focusComment">
          <view class="icon">ğŸ’¬</view>
          <view class="label">{{comments.length}}</view>
        </view>
        <view class="action-item reaction-area" catch:tap="toggleReactionPopup">
          <view class="icon">ğŸ˜Š</view>
          <view class="label">è¡¨æƒ…</view>
        </view>
      </view>

      <!-- Comments Section (New Recursive Structure) -->
      <template name="commentItem">
        <view class="comment {{isChild ? 'child-comment' : ''}}">
          <image class="c-avatar" src="{{comment.authorAvatarUrl}}" />
          <view class="c-meta">
            <view class="name-line">
              <view class="c-name">{{comment.authorNickName}}</view>
              <view class="badges-wrapper">
                <view wx:if="{{comment.authorIsAdmin}}">
                  <t-icon name="check-circle-filled" size="28rpx" color="gold" />
                </view>
                <text class="badge personal-badge" wx:if="{{comment.authorRole === 'ä¸ªäººè®¤è¯'}}">å·²è®¤è¯?/text>
              </view>
            </view>
            <view class="c-text">
              <block wx:if="{{comment.replyToNickName}}">
                <text class="reply-to">å›å¤ @{{comment.replyToNickName}}: </text>
              </block>
              {{comment.content}}
            </view>
            <view class="c-footer">
              <view class="c-time">{{comment.time}}</view>
              <view class="reply-btn" bind:tap="onReply" data-comment="{{comment}}">å›å¤</view>
            </view>
            <!-- Recursive call for child comments -->
            <view class="child-comments-wrapper" wx:if="{{comment.children && comment.children.length > 0}}">
              <block wx:for="{{comment.children}}" wx:for-item="childComment" wx:key="_id">
                <template is="commentItem" data="{{comment: childComment, isChild: true}}" />
              </block>
            </view>
          </view>
        </view>
      </template>

      <view class="comments" wx:if="{{comments.length > 0}}">
        <view class="comments-title">æ‰€æœ‰è¯„è®?/view>
        <block wx:for="{{comments}}" wx:key="_id">
          <template is="commentItem" data="{{comment: item, isChild: false}}" />
        </block>
      </view>
      
      <view class="status muted" wx:else>
        è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼?      </view>

    </block>
  </view>

  <view class="input-bar" style="position: fixed; left: 2rpx; top: 1443rpx; height: 168rpx; display: flex; box-sizing: border-box">
    <view class="reply-indicator" wx:if="{{isReplying}}">
      <view class="reply-indicator-text">å›å¤ @{{replyInfo.nickName}}</view>
      <view class="cancel-reply-btn" bind:tap="cancelReply">Ã—</view>
    </view>
    <input style="height: 106rpx; display: block; box-sizing: border-box; position: relative; left: 25rpx; top: 4rpx; width: 572rpx" class="input" placeholder="{{inputPlaceholder}}" value="{{commentInputValue}}" bindinput="onCommentInputChange" focus="{{inputFocused}}" />
    <view class="send" bind:tap="submitComment" style="height: 58rpx; display: block; box-sizing: border-box; width: 106rpx; position: relative; left: 622rpx; top: -80rpx">å‘é€?/view>
  </view>

  <!-- Popup Layer -->
  <view class="popup-layer" wx:if="{{showReactionPanel}}">
    <view class="popup-overlay" bind:tap="toggleReactionPopup"></view>
    <view class="reaction-popup" catchtap="noop">
      <text class="emoji" wx:for="{{availableReactions}}" wx:key="*this" catchtap="onSelectReaction" data-emoji="{{item}}">{{item}}</text>
    </view>
  </view>

</view>
